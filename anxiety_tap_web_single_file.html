<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>焦慮戳戳（Web 版）</title>
  <meta name="description" content="離線本機儲存、超大紅色按鈕、今日/本週/總計統計，含 CSV 匯出與蓄力音效。單檔可直接開啟。" />
  <style>
    :root {
      --card: #15161a;
      --fg: #e9eaee;
      --muted: #9aa0a6;
      --accent: #e53935; /* red */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:radial-gradient(1200px 600px at 80% 20%,#17181c 0%,#0d0e12 60%,#090a0d 100%);color:var(--fg);-webkit-tap-highlight-color:transparent}
    .container{max-width:720px;margin:0 auto;padding:20px 16px 32px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-size:clamp(20px,3.2vw,28px);font-weight:800;letter-spacing:.2px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .chip{background:#0f1014;border:1px solid #22242b;border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted)}
    .card{background:var(--card);border:1px solid #22242b;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:saturate(1.2) blur(6px)}
    .center{display:flex;align-items:center;justify-content:center}
    .big-btn{width:240px;height:240px;border-radius:999px;border:none;cursor:pointer;position:relative;outline:none;background:radial-gradient(120px 120px at 60% 35%,#ff5b5b,var(--accent));box-shadow:0 30px 60px rgba(229,57,53,.45),inset 0 -12px 24px rgba(0,0,0,.35);color:#fff;font-size:48px;font-weight:900;letter-spacing:2px;transition:transform .12s ease,box-shadow .12s ease;user-select:none;touch-action:manipulation}
    .big-btn:active{transform:scale(.96);box-shadow:0 18px 36px rgba(229,57,53,.35),inset 0 -8px 18px rgba(0,0,0,.45)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{background:#111217;border:1px solid #262832;color:var(--fg);border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#2f3240}
    .btn-tonal{background:#1a1b22;border-color:#2a2c36}
    .btn-danger{background:#1d1111;border-color:#3d1f1f;color:#ffc9c9}
    .pill{display:inline-flex;border:1px solid #2b2e39;padding:4px;border-radius:999px;gap:4px}
    .pill button{border:none;background:transparent;color:var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
    .pill button[aria-pressed="true"]{background:#0f1014;color:var(--fg)}
    .section{margin-top:24px}
    #chart{width:100%;height:280px}
    .hint{color:var(--muted);font-size:12px}
    .level-badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a2c36;color:#cbd5e1;background:#101218}
    @media (max-width:420px){.big-btn{width:200px;height:200px;font-size:40px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">焦慮戳戳（Web 版）</div>
      <div class="stats" aria-live="polite">
        <span class="chip" id="badge">LV1 平穩</span>
        <span class="chip" id="today">今天：0 次</span>
        <span class="chip" id="week">本週：0</span>
        <span class="chip" id="total">總計：0</span>
      </div>
    </header>

    <main>
      <section class="section center" style="min-height:260px;">
        <button class="big-btn" id="tapBtn" aria-label="大按鈕，點按加一；長按蓄力後放開加一並播放重音">戳！</button>
      </section>

      <section class="section card">
        <div class="row" style="margin-bottom:12px;">
          <div class="pill" role="tablist" aria-label="統計範圍">
            <button role="tab" id="range-7" data-days="7" aria-pressed="false">7 天</button>
            <button role="tab" id="range-14" data-days="14" aria-pressed="true">14 天</button>
            <button role="tab" id="range-30" data-days="30" aria-pressed="false">30 天</button>
          </div>
          <span class="level-badge" id="levelBadge">LV1 平穩</span>
        </div>
        <div id="chart" aria-label="最近幾天的每日次數長條圖"></div>
        <div class="row" style="margin-top:12px;">
          <div class="hint">資料只存在你的瀏覽器，不會上傳（清除瀏覽器資料或換裝置會遺失）。</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn btn-tonal" id="exportBtn">匯出 CSV</button>
            <button class="btn" id="soundBtn" aria-pressed="true" title="切換音效">音效：開</button>
            <label class="hint" for="volRange">音量</label>
            <input id="volRange" type="range" min="0" max="100" value="70" style="width:120px;" />
            <button class="btn btn-danger" id="resetBtn">重設</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== Utilities ======
    const fmt = new Intl.DateTimeFormat('zh-Hant', { month: 'numeric', day: 'numeric' });
    const todayStart = (d=new Date()) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
    const startOfWeek = (d=new Date()) => { const x = todayStart(d); const day = x.getDay(); const diff = (day === 0 ? -6 : 1) - day; x.setDate(x.getDate() + diff); return x; };

    // Haptics (best-effort)
    function haptic(ms=15){ try { if (navigator.vibrate) navigator.vibrate(ms); } catch (e) {} }

    // ====== Sound (Web Audio; no external files) ======
    const SOUND_ENABLED_KEY = 'anxiety_taps_sound_enabled';
    const SOUND_VOL_KEY = 'anxiety_taps_sound_vol';
    let audioCtx = null; // lazy init
    function isSoundEnabled(){ const v = localStorage.getItem(SOUND_ENABLED_KEY); return v === null ? true : v === '1'; }
    function setSoundEnabled(on){ localStorage.setItem(SOUND_ENABLED_KEY, on ? '1':'0'); }
    function getVolume(){ const v = Number(localStorage.getItem(SOUND_VOL_KEY)); return Number.isFinite(v) ? Math.min(100, Math.max(0,v)) : 70; }
    function setVolume(v){ localStorage.setItem(SOUND_VOL_KEY, String(Math.min(100, Math.max(0,v)))); }
    function ensureAudio(){ if (!audioCtx){ const Ctx = window.AudioContext || window.webkitAudioContext; if (Ctx) audioCtx = new Ctx(); }
      if (audioCtx && audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); } return !!audioCtx; }

    // 短按音：輕快往上滑的 sine
    function playPing(){ if (!isSoundEnabled()) return; if (!ensureAudio()) return; const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.06);
      const vol = getVolume()/100; const maxGain = 0.22 * vol; gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(maxGain, now+0.008); gain.gain.exponentialRampToValueAtTime(0.0008, now+0.12);
      osc.connect(gain).connect(audioCtx.destination); osc.start(now); osc.stop(now+0.16); }

    // 長按後放開的重音：兩個振盪器 + 衰減更慢；力度依蓄力 charge(0..1)
    function playBoom(charge){ if (!isSoundEnabled()) return; if (!ensureAudio()) return; const now = audioCtx.currentTime; const vol = getVolume()/100;
      const baseGain = 0.28 + 0.5 * charge; // 0.28..0.78
      const maxGain = Math.min(0.6, baseGain) * vol; // 安全上限

      // 低頻下滑的 sine
      const osc1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
      osc1.type='sine'; osc1.frequency.setValueAtTime(220, now); osc1.frequency.exponentialRampToValueAtTime(110, now + (0.12 + 0.18*charge));
      g1.gain.setValueAtTime(0, now); g1.gain.linearRampToValueAtTime(maxGain, now+0.01);
      g1.gain.exponentialRampToValueAtTime(0.0006, now + (0.35 + 0.45*charge));
      osc1.connect(g1).connect(audioCtx.destination);

      // 加一點方波厚度
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type='square'; osc2.frequency.setValueAtTime(110, now); osc2.frequency.exponentialRampToValueAtTime(80, now + (0.12 + 0.18*charge));
      g2.gain.setValueAtTime(0, now); g2.gain.linearRampToValueAtTime(maxGain*0.6, now+0.012);
      g2.gain.exponentialRampToValueAtTime(0.0006, now + (0.35 + 0.45*charge));
      osc2.connect(g2).connect(audioCtx.destination);

      osc1.start(now); osc2.start(now);
      const stopAt = now + (0.4 + 0.5*charge);
      osc1.stop(stopAt); osc2.stop(stopAt);
    }

    // ====== Storage (localStorage, timestamps as epoch ms) ======
    const KEY = 'anxiety_taps_events_v1';
    function readEvents(){ try { const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function writeEvents(arr){ try { localStorage.setItem(KEY, JSON.stringify(arr)); } catch {} }
    function addEvent(ts=Date.now()){ const arr = readEvents(); arr.push(ts); writeEvents(arr); }
    function resetAll(){ writeEvents([]); }

    // ====== Stats ======
    function counts(){ const arr = readEvents(); const calToday = todayStart(); const weekStart = startOfWeek(); let today=0, week=0; for (const t of arr){ if (t >= calToday.getTime()) today++; if (t >= weekStart.getTime()) week++; } return { today, week, total: arr.length }; }
    function lastNDaysSeries(days){ const start = todayStart(); start.setDate(start.getDate() - (days - 1)); const buckets = new Map(); for (let i=0;i<days;i++){ const d = new Date(start); d.setDate(start.getDate()+i); buckets.set(todayStart(d).getTime(), 0); }
      for (const t of readEvents()){ if (t >= start.getTime()){ const key = todayStart(new Date(t)).getTime(); buckets.set(key, (buckets.get(key)||0) + 1); } }
      return Array.from(buckets.entries()).map(([k,v]) => ({ x: new Date(Number(k)), y: v })); }
    function levelBadge(todayCount){ if (todayCount < 20) return 'LV1 平穩'; if (todayCount < 60) return 'LV2 專注'; if (todayCount < 120) return 'LV3 充能'; return 'LV4 爆衝'; }

    // ====== Chart (SVG) ======
    function renderBarChart(el, data){ const W = el.clientWidth || 640; const H = 260; const P = { l: 28, r: 16, t: 16, b: 30 }; const innerW = W - P.l - P.r; const innerH = H - P.t - P.b; const maxY = Math.max(1, ...data.map(d => d.y)); const stepX = innerW / data.length; const barW = Math.max(6, Math.min(22, stepX * 0.6)); const svgNS = 'http://www.w3.org/2000/svg'; const svg = document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.setAttribute('width','100%'); svg.setAttribute('height',H);
      const grid = document.createElementNS(svgNS,'g'); for (let i=0;i<=4;i++){ const y = P.t + innerH * (i/4); const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1',P.l); line.setAttribute('x2',W-P.r); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','#2a2d36'); line.setAttribute('stroke-width','1'); line.setAttribute('opacity', i===0?1:.6); grid.appendChild(line);} svg.appendChild(grid);
      const bars = document.createElementNS(svgNS,'g'); data.forEach((d,i)=>{ const x = P.l + i * stepX + (stepX - barW)/2; const h = Math.round(innerH * (d.y / maxY)); const y = P.t + innerH - h; const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',h); rect.setAttribute('rx',4); rect.setAttribute('fill','url(#grad)'); rect.setAttribute('opacity', d.y>0?1:0.6); bars.appendChild(rect);
        if (d.y>0){ const label = document.createElementNS(svgNS,'text'); label.setAttribute('x', x + barW/2); label.setAttribute('y', y - 6); label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','11'); label.setAttribute('fill','#aab2c0'); label.textContent = d.y; bars.appendChild(label);} const tick = document.createElementNS(svgNS,'text'); tick.setAttribute('x', P.l + i*stepX + stepX/2); tick.setAttribute('y', H - 8); tick.setAttribute('text-anchor','middle'); tick.setAttribute('font-size','11'); tick.setAttribute('fill','#8a909c'); tick.textContent = fmt.format(d.x); bars.appendChild(tick); }); svg.appendChild(bars);
      const defs = document.createElementNS(svgNS,'defs'); const grad = document.createElementNS(svgNS,'linearGradient'); grad.setAttribute('id','grad'); grad.setAttribute('x1','0'); grad.setAttribute('x2','0'); grad.setAttribute('y1','0'); grad.setAttribute('y2','1'); const s1 = document.createElementNS(svgNS,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#ff6b6b'); const s2 = document.createElementNS(svgNS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#e53935'); grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);
      el.replaceChildren(svg); }

    // ====== UI Wiring ======
    const tapBtn = document.getElementById('tapBtn');
    const todayEl = document.getElementById('today');
    const weekEl = document.getElementById('week');
    const totalEl = document.getElementById('total');
    const badgeEl = document.getElementById('badge');
    const levelEl = document.getElementById('levelBadge');
    const chartEl = document.getElementById('chart');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const soundBtn = document.getElementById('soundBtn');
    const volRange = document.getElementById('volRange');
    const rangeBtns = Array.from(document.querySelectorAll('.pill button'));

    let days = 14;

    function refresh(){ const { today, week, total } = counts(); todayEl.textContent = `今天：${today} 次`; weekEl.textContent = `本週：${week}`; totalEl.textContent = `總計：${total}`; const badge = levelBadge(today); badgeEl.textContent = badge; levelEl.textContent = badge; renderBarChart(chartEl, lastNDaysSeries(days)); }

    // ---- 長按蓄力 & 釋放重音 ----
    const LONG_MS = 400;           // 超過此值視為長按
    const MAX_CHARGE_MS = 1500;    // 滿蓄力
    let pressStart = 0;

    function computeCharge(ms){ return Math.max(0, Math.min(1, ms / MAX_CHARGE_MS)); }

    // 使用 Pointer Events 支援滑鼠與觸控
    tapBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      pressStart = performance.now();
      try { tapBtn.setPointerCapture(e.pointerId); } catch {}
      haptic(10);
    });

    function finalizePress(e){
      if (!pressStart) return; // 已處理或未開始
      const dur = performance.now() - pressStart; pressStart = 0;
      try { tapBtn.releasePointerCapture(e.pointerId); } catch {}

      addEvent();
      if (dur >= LONG_MS){
        const charge = computeCharge(dur);
        haptic(30 + Math.round(50*charge));
        playBoom(charge);
      } else {
        haptic(15);
        playPing();
      }
      refresh();
    }

    tapBtn.addEventListener('pointerup', (e) => { e.preventDefault(); finalizePress(e); });
    tapBtn.addEventListener('pointercancel', (e) => { e.preventDefault(); pressStart = 0; try { tapBtn.releasePointerCapture(e.pointerId); } catch {} });
    tapBtn.addEventListener('pointerleave', (e) => { if (pressStart){ // 視為取消，避免拖出按鈕誤觸
      e.preventDefault(); pressStart = 0; try { tapBtn.releasePointerCapture(e.pointerId); } catch {} }
    });
    tapBtn.addEventListener('contextmenu', (e) => e.preventDefault()); // 手機長按不跳選單

    // 範圍切換
    rangeBtns.forEach(btn => btn.addEventListener('click', () => { rangeBtns.forEach(b => b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); days = Number(btn.dataset.days || '14'); refresh(); }));

    // 匯出 / 重設
    exportBtn.addEventListener('click', () => { const rows = readEvents().sort((a,b)=>a-b).map(ts => new Date(ts)).map(d => `${d.toISOString()}`); const csv = 'timestamp_iso8601\n' + rows.join('\n') + '\n'; const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'anxiety-taps.csv'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 5000); });
    resetBtn.addEventListener('click', () => { if (confirm('確定要清空所有紀錄？此動作無法復原。')){ writeEvents([]); refresh(); } });

    // 音效控制
    function refreshSoundUI(){ const on = isSoundEnabled(); soundBtn.setAttribute('aria-pressed', on ? 'true':'false'); soundBtn.textContent = `音效：${on ? '開':'關'}`; volRange.value = String(getVolume()); }
    soundBtn.addEventListener('click', () => { const next = !isSoundEnabled(); setSoundEnabled(next); if (next){ ensureAudio(); playPing(); } refreshSoundUI(); });
    volRange.addEventListener('input', () => { setVolume(Number(volRange.value || '70')); });

    // Resize redraw (debounced)
    let resizeTimer = null; window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(() => renderBarChart(chartEl, lastNDaysSeries(days)), 120); });

    // 初次渲染
    refreshSoundUI();
    refresh();

    // ====== Minimal Self Tests (console) ======
    (function runTests(){
      const results = [];
      const approx = (a,b,eps=1e-6)=>Math.abs(a-b)<=eps;
      function assert(name, cond){ results.push({ name, pass: !!cond }); }

      // DOM presence
      assert('#tapBtn exists', !!tapBtn);
      assert('#today exists', !!todayEl);
      assert('#chart exists', !!chartEl);

      // computeCharge tests
      assert('computeCharge(0) == 0', computeCharge(0) === 0);
      assert('computeCharge(MAX_CHARGE_MS) == 1', computeCharge(MAX_CHARGE_MS) === 1);
      assert('computeCharge(MAX_CHARGE_MS*2) == 1 (clamped)', computeCharge(MAX_CHARGE_MS*2) === 1);
      assert('computeCharge(MAX_CHARGE_MS/2) ≈ 0.5', approx(computeCharge(MAX_CHARGE_MS/2), 0.5, 0.01));

      // Stats logic with synthetic data
      const backup = readEvents();
      writeEvents([]);
      const now = Date.now();
      addEvent(now - 1000); // today
      addEvent(now - 1000*60*60*24*2); // 2 days ago
      const cs = counts();
      assert('today >= 1 after adding event', cs.today >= 1);
      assert('total == 2 after adding two', cs.total === 2);
      const series = lastNDaysSeries(3);
      assert('series length 3', series.length === 3);
      writeEvents(backup);

      console.groupCollapsed('Self-tests for Anxiety Tap (long-press)');
      for (const r of results){ console.log(r.pass ? '✅' : '❌', r.name); }
      console.groupEnd();
    })();

  });
  </script>
</body>
</html>
