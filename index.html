<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>焦慮戳戳（Web 版）</title>
  <meta name="description" content="離線本機儲存、超大紅色按鈕、今日/本週/總計統計，含 CSV 匯出與蓄力音效。單檔可直接開啟。" />
  <style>
    :root {
      --card: #15161a;
      --fg: #e9eaee;
      --muted: #9aa0a6;
      --accent: #e53935; /* red */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(1200px 600px at 80% 20%,#17181c 0%,#0d0e12 60%,#090a0d 100%);
      color:var(--fg);
      -webkit-tap-highlight-color:transparent;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      min-height:100vh;
      min-height:100dvh;
      display:flex;
      flex-direction:column
    }
    .container{
      max-width:720px;
      margin:0 auto;
      padding:max(40px, env(safe-area-inset-top) + 20px) 16px max(40px, env(safe-area-inset-bottom) + 20px);
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:0
    }
    header{display:flex;align-items:center;justify-content:center;gap:12px;flex-direction:column;text-align:center}
    .title{font-size:clamp(20px,3.2vw,28px);font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:clamp(12px,2vw,16px);color:var(--muted);font-weight:400;margin-top:4px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .chip{background:#0f1014;border:1px solid #22242b;border-radius:999px;padding:8px 12px;font-size:13px;color:var(--muted)}
    .card{background:var(--card);border:1px solid #22242b;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);backdrop-filter:saturate(1.2) blur(6px)}
    .center{display:flex;align-items:center;justify-content:center;flex-direction:column}
    .big-btn{
      width:clamp(300px, 65vw, 400px);
      height:clamp(300px, 65vw, 400px);
      border-radius:999px;
      border:none;
      cursor:pointer;
      position:relative;
      outline:none;
      background:radial-gradient(120px 120px at 60% 35%,#ff5b5b,var(--accent));
      box-shadow:0 30px 60px rgba(229,57,53,.45),inset 0 -12px 24px rgba(0,0,0,.35);
      color:#fff;
      font-size:clamp(36px, 8vw, 48px);
      font-weight:900;
      letter-spacing:2px;
      transition:transform .12s ease,box-shadow .12s ease;
      user-select:none;
      -webkit-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      touch-action:manipulation;
      -webkit-touch-callout:none;
      -webkit-appearance:none
    }
    .big-btn:active{transform:scale(.94);box-shadow:0 18px 36px rgba(229,57,53,.35),inset 0 -8px 18px rgba(0,0,0,.45)}
    .big-btn::before{content:'';position:absolute;top:-20px;left:-20px;right:-20px;bottom:-20px;border-radius:999px;background:conic-gradient(from 0deg,#ff6b6b,#ff4757,#ff3742,#ff6b6b);opacity:0;animation:spin 2s linear infinite;transition:opacity .3s ease;z-index:-1}
    .big-btn.charging::before{opacity:0.8}
    .big-btn.exploding{animation:explode .6s ease-out}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @keyframes explode{0%{transform:scale(1)}20%{transform:scale(1.2)}40%{transform:scale(0.9)}100%{transform:scale(1)}}
    @keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-3px)}20%,40%,60%,80%{transform:translateX(3px)}}
    .screen-shake{animation:shake 0.5s ease-in-out}
    .particle{position:absolute;width:8px;height:8px;background:#ff6b6b;border-radius:50%;pointer-events:none;z-index:1000}
    @keyframes particle-explosion{0%{transform:scale(1) translate(0,0);opacity:1}100%{transform:scale(0) translate(var(--dx),var(--dy));opacity:0}}
    .particle.exploding{animation:particle-explosion 0.8s ease-out forwards}
    .big-counter{font-size:clamp(60px,12vw,120px);font-weight:900;color:var(--fg);text-align:center;margin-top:24px;letter-spacing:4px;text-shadow:0 4px 20px rgba(233,234,238,.3);transition:all .2s ease}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{background:#111217;border:1px solid #262832;color:var(--fg);border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#2f3240}
    .btn-tonal{background:#1a1b22;border-color:#2a2c36}
    .btn-danger{background:#1d1111;border-color:#3d1f1f;color:#ffc9c9}
    .pill{display:inline-flex;border:1px solid #2b2e39;padding:4px;border-radius:999px;gap:4px}
    .pill button{border:none;background:transparent;color:var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
    .pill button[aria-pressed="true"]{background:#0f1014;color:var(--fg)}
    main{flex:1;display:flex;flex-direction:column;justify-content:center;min-height:0}
    .button-section{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px 0;transform:translateY(5vh)}
    .controls-section{flex-shrink:0;padding:20px 0}
    .section{margin-top:24px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">焦慮戳戳樂</div>
      <div class="subtitle">真實的人類，真實的焦慮</div>
    </header>

    <main>
      <div class="button-section">
        <button class="big-btn" id="tapBtn" aria-label="大按鈕，點按加一；長按蓄力後放開加一並播放重音">戳！</button>
        <div class="big-counter" id="bigCounter">0</div>
      </div>

      <div class="controls-section">
        <div class="card">
          <div class="row">
            <button class="btn" id="soundBtn" aria-pressed="true" title="切換音效">音效：開</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== Utilities ======

    // Haptics (best-effort)
    function haptic(ms=15){ try { if (navigator.vibrate) navigator.vibrate(ms); } catch (e) {} }

    // ====== Sound (Web Audio; no external files) ======
    const SOUND_ENABLED_KEY = 'anxiety_taps_sound_enabled';
    let audioCtx = null; // lazy init
    function isSoundEnabled(){ const v = localStorage.getItem(SOUND_ENABLED_KEY); return v === null ? true : v === '1'; }
    function setSoundEnabled(on){ localStorage.setItem(SOUND_ENABLED_KEY, on ? '1':'0'); }
    function ensureAudio(){ if (!audioCtx){ const Ctx = window.AudioContext || window.webkitAudioContext; if (Ctx) audioCtx = new Ctx(); }
      if (audioCtx && audioCtx.state === 'suspended'){ audioCtx.resume().catch(()=>{}); } return !!audioCtx; }

    // 短按音：輕快往上滑的 sine
    function playPing(){ if (!isSoundEnabled()) return; if (!ensureAudio()) return; const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.06);
      const maxGain = 0.22; gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(maxGain, now+0.008); gain.gain.exponentialRampToValueAtTime(0.0008, now+0.12);
      osc.connect(gain).connect(audioCtx.destination); osc.start(now); osc.stop(now+0.16); }

    // 長按後放開的重音：兩個振盪器 + 衰減更慢；力度依蓄力 charge(0..1)
    function playBoom(charge){ if (!isSoundEnabled()) return; if (!ensureAudio()) return; const now = audioCtx.currentTime;
      const baseGain = 0.28 + 0.5 * charge; // 0.28..0.78
      const maxGain = Math.min(0.6, baseGain); // 安全上限

      // 低頻下滑的 sine
      const osc1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
      osc1.type='sine'; osc1.frequency.setValueAtTime(220, now); osc1.frequency.exponentialRampToValueAtTime(110, now + (0.12 + 0.18*charge));
      g1.gain.setValueAtTime(0, now); g1.gain.linearRampToValueAtTime(maxGain, now+0.01);
      g1.gain.exponentialRampToValueAtTime(0.0006, now + (0.35 + 0.45*charge));
      osc1.connect(g1).connect(audioCtx.destination);

      // 加一點方波厚度
      const osc2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
      osc2.type='square'; osc2.frequency.setValueAtTime(110, now); osc2.frequency.exponentialRampToValueAtTime(80, now + (0.12 + 0.18*charge));
      g2.gain.setValueAtTime(0, now); g2.gain.linearRampToValueAtTime(maxGain*0.6, now+0.012);
      g2.gain.exponentialRampToValueAtTime(0.0006, now + (0.35 + 0.45*charge));
      osc2.connect(g2).connect(audioCtx.destination);

      osc1.start(now); osc2.start(now);
      const stopAt = now + (0.4 + 0.5*charge);
      osc1.stop(stopAt); osc2.stop(stopAt);
    }

    // ====== Storage (localStorage, timestamps as epoch ms) ======
    const KEY = 'anxiety_taps_events_v1';
    function readEvents(){ try { const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function writeEvents(arr){ try { localStorage.setItem(KEY, JSON.stringify(arr)); } catch {} }
    function addEvent(ts=Date.now()){ const arr = readEvents(); arr.push(ts); writeEvents(arr); }
    function resetAll(){ writeEvents([]); }

    // ====== Stats ======
    function totalCount(){ return readEvents().length; }


    // ====== UI Wiring ======
    const tapBtn = document.getElementById('tapBtn');
    const bigCounter = document.getElementById('bigCounter');
    const soundBtn = document.getElementById('soundBtn');

    function refresh(){ const total = totalCount(); bigCounter.textContent = total; }

    // ---- 長按蓄力 & 釋放重音 ----
    const LONG_MS = 400;           // 超過此值視為長按
    const MAX_CHARGE_MS = 1500;    // 滿蓄力
    let pressStart = 0;

    function computeCharge(ms){ return Math.max(0, Math.min(1, ms / MAX_CHARGE_MS)); }

    // 動畫效果函數
    function createParticleExplosion(x, y, intensity = 1) {
      const particleCount = Math.floor(12 * intensity);
      const container = document.body;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // 隨機方向和距離
        const angle = (Math.PI * 2 * i) / particleCount + (Math.random() - 0.5) * 0.5;
        const distance = 100 + Math.random() * 100 * intensity;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;
        
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--dx', dx + 'px');
        particle.style.setProperty('--dy', dy + 'px');
        
        container.appendChild(particle);
        
        // 觸發動畫
        requestAnimationFrame(() => {
          particle.classList.add('exploding');
        });
        
        // 清理
        setTimeout(() => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        }, 800);
      }
    }

    function screenShake(intensity = 1) {
      document.body.classList.add('screen-shake');
      setTimeout(() => {
        document.body.classList.remove('screen-shake');
      }, 500 * intensity);
    }

    // 使用 Pointer Events 支援滑鼠與觸控
    let chargeTimer = null;
    
    tapBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      pressStart = performance.now();
      try { tapBtn.setPointerCapture(e.pointerId); } catch {}
      haptic(10);
      
      // 延遲啟動充電動畫（長按才顯示）
      chargeTimer = setTimeout(() => {
        tapBtn.classList.add('charging');
      }, LONG_MS);
    });

    function finalizePress(e){
      if (!pressStart) return; // 已處理或未開始
      const dur = performance.now() - pressStart; pressStart = 0;
      try { tapBtn.releasePointerCapture(e.pointerId); } catch {}
      
      // 清理充電狀態
      if (chargeTimer) {
        clearTimeout(chargeTimer);
        chargeTimer = null;
      }
      tapBtn.classList.remove('charging');

      addEvent();
      if (dur >= LONG_MS){
        const charge = computeCharge(dur);
        haptic(30 + Math.round(50*charge));
        playBoom(charge);
        
        // 爆炸動畫效果
        tapBtn.classList.add('exploding');
        setTimeout(() => tapBtn.classList.remove('exploding'), 600);
        
        // 粒子爆炸效果
        const rect = tapBtn.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        createParticleExplosion(centerX, centerY, charge);
        
        // 螢幕震動效果
        screenShake(charge);
        
      } else {
        haptic(15);
        playPing();
      }
      refresh();
    }

    tapBtn.addEventListener('pointerup', (e) => { e.preventDefault(); finalizePress(e); });
    
    tapBtn.addEventListener('pointercancel', (e) => { 
      e.preventDefault(); 
      pressStart = 0; 
      if (chargeTimer) { clearTimeout(chargeTimer); chargeTimer = null; }
      tapBtn.classList.remove('charging');
      try { tapBtn.releasePointerCapture(e.pointerId); } catch {} 
    });
    
    tapBtn.addEventListener('pointerleave', (e) => { 
      if (pressStart){ // 視為取消，避免拖出按鈕誤觸
        e.preventDefault(); 
        pressStart = 0; 
        if (chargeTimer) { clearTimeout(chargeTimer); chargeTimer = null; }
        tapBtn.classList.remove('charging');
        try { tapBtn.releasePointerCapture(e.pointerId); } catch {} 
      }
    });
    tapBtn.addEventListener('contextmenu', (e) => e.preventDefault()); // 手機長按不跳選單



    // 音效控制
    function refreshSoundUI(){ const on = isSoundEnabled(); soundBtn.setAttribute('aria-pressed', on ? 'true':'false'); soundBtn.textContent = `音效：${on ? '開':'關'}`; }
    soundBtn.addEventListener('click', () => { const next = !isSoundEnabled(); setSoundEnabled(next); if (next){ ensureAudio(); playPing(); } refreshSoundUI(); });


    // 初次渲染
    function initializeApp() {
      refreshSoundUI();
      refresh();
    }
    
    initializeApp();

    // ====== Minimal Self Tests (console) ======
    (function runTests(){
      const results = [];
      const approx = (a,b,eps=1e-6)=>Math.abs(a-b)<=eps;
      function assert(name, cond){ results.push({ name, pass: !!cond }); }

      // DOM presence
      assert('#tapBtn exists', !!tapBtn);
      assert('#today exists', !!todayEl);
      assert('#chart exists', !!chartEl);

      // computeCharge tests
      assert('computeCharge(0) == 0', computeCharge(0) === 0);
      assert('computeCharge(MAX_CHARGE_MS) == 1', computeCharge(MAX_CHARGE_MS) === 1);
      assert('computeCharge(MAX_CHARGE_MS*2) == 1 (clamped)', computeCharge(MAX_CHARGE_MS*2) === 1);
      assert('computeCharge(MAX_CHARGE_MS/2) ≈ 0.5', approx(computeCharge(MAX_CHARGE_MS/2), 0.5, 0.01));

      // Stats logic with synthetic data
      const backup = readEvents();
      writeEvents([]);
      const now = Date.now();
      addEvent(now - 1000); // today
      addEvent(now - 1000*60*60*24*2); // 2 days ago
      const cs = counts();
      assert('today >= 1 after adding event', cs.today >= 1);
      assert('total == 2 after adding two', cs.total === 2);
      const series = lastNDaysSeries(3);
      assert('series length 3', series.length === 3);
      writeEvents(backup);

      console.groupCollapsed('Self-tests for Anxiety Tap (long-press)');
      for (const r of results){ console.log(r.pass ? '✅' : '❌', r.name); }
      console.groupEnd();
    })();

  });
  </script>
</body>
</html>
